#!/usr/bin/env bash

set -e
set -u
set -o pipefail

source $(dirname $0)/../etc/config
source $LIBEXEC_DIR/k8s-functions

log-header "installing TAP ($TAP_VERSION)"

log-message "installing Tanzu CLI"
cli_dist=$LOCAL_DIST_DIR/tanzu-framework-$PLATFORM-amd64-$TAP_VERSION.tar
if [[ ! -f $cli_dist ]]; then
  log-error "Tanzu CLI dist not found: $(basename $cli_dist)"
  log-error "see https://github.com/steeltoeoss-incubator/tanzu-thingies#tanzu-cli"
  die
fi
rm -f $LOCAL_BIN_DIR/tanzu
cli_dir=$LOCAL_TOOL_DIR/tanzu-framework-$TAP_VERSION
rm -rf $cli_dir
mkdir -p $cli_dir
tar xf $cli_dist -C $cli_dir
mkdir -p $LOCAL_BIN_DIR
install $cli_dir/cli/core/v*/tanzu-core-${PLATFORM}_amd64 $LOCAL_BIN_DIR/tanzu
hash -r
tanzu version
log-message "installing Tanzu CLI plugins"
tanzu plugin install --local $cli_dir/cli all

log-message "installing Tanzu Cluster Essentials"
essentials_dist=$LOCAL_DIST_DIR/tanzu-cluster-essentials-$PLATFORM-amd64-$TANZU_ESSENTIALS_VERSION.tgz
if [[ ! -f $essentials_dist ]]; then
  log-error "Tanzu Cluster Essentials dist not found: $(basename $essentials_dist)"
  log-error "see https://github.com/steeltoeoss-incubator/tanzu-thingies#tanzu-cluster-essentials"
  die
fi
essentials_dir=$LOCAL_TOOL_DIR/tanzu-cluster-essentials-$TANZU_ESSENTIALS_VERSION
rm -rf $essentials_dir
mkdir -p $essentials_dir
tar xf $essentials_dist -C $essentials_dir
pushd $essentials_dir
./install.sh --yes
popd

log-message "checking kapp-controller, secretgen-controller"
kubectl get pods --all-namespaces | grep -E 'kapp-controller|secretgen-controller'

create-namespace $TAP_NAMESPACE

log-message "adding tap-registry credentials ($TAP_NAMESPACE)"

tanzu secret registry add tap-registry \
  --server $TANZUNET_HOST \
  --username $TANZUNET_USER \
  --password $TANZUNET_PASS \
  --namespace $TAP_NAMESPACE \
  --export-to-all-namespaces \
  --yes

log-message "adding registry credentials ($TAP_NAMESPACE)"
tanzu secret registry add registry-credentials \
  --server $REGISTRY_HOST \
  --username $REGISTRY_USER \
  --password $REGISTRY_PASS \
  --namespace $TAP_NAMESPACE

log-message "adding repository"
tanzu package repository add tanzu-tap-repository \
  --url $TANZUNET_HOST/tanzu-application-platform/tap-packages:$TAP_VERSION \
  --namespace $TAP_NAMESPACE

log-message "checking repository status"
tanzu package repository get tanzu-tap-repository --namespace $TAP_NAMESPACE

log-message "listing packages"
tanzu package available list --namespace $TAP_NAMESPACE

log-message "installing TAP (this may take a while)"
tap_profile=$CONFIG_DIR/tap-profile.yaml
if [[ ! -f $tap_profile ]]; then
  log-error "TAP profile not found: $(basename $tap_profile)"
  log-error "see https://github.com/steeltoeoss-incubator/tanzu-thingies#tap-profile"
  die
fi
tanzu package install tap \
  -p tap.tanzu.vmware.com \
  -v $TAP_VERSION \
  --values-file $tap_profile \
  --poll-timeout 45m \
  --namespace $TAP_NAMESPACE

log-header "creating developer environment"

create-namespace $TAP_DEV_NAMESPACE

log-message "adding registry credentials ($TAP_DEV_NAMESPACE)"
tanzu secret registry add registry-credentials \
  --server $REGISTRY_HOST \
  --username $REGISTRY_USER \
  --password $REGISTRY_PASS \
  --namespace $TAP_DEV_NAMESPACE

log-message "adding service roles"
kubectl -n $TAP_DEV_NAMESPACE apply -f $CONFIG_DIR/serviceaccounts.yaml
